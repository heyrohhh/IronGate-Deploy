- name: Deploy Inventory Application
  hosts: app
  connection: amazon.aws.aws_ssm
  gather_facts: false
  vars:
    ansible_aws_ssm_region: us-east-1
  tasks:
    - name: Test SSM command execution
      raw: uptime
      become: true
      register: uptime_output

    - name: Debug Output
      debug:
        msg: "{{ uptime_output.stdout }}"

    - name: Ensure Docker is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Create app directory
      ansible.builtin.file:
        path: /home/ec2-user/app
        state: directory
        owner: ec2-user
        group: ec2-user
        mode: "0755"

    - name: Copy docker-compose file
      ansible.builtin.copy:
        src: files/docker-compose.yml
        dest: /home/ec2-user/app/docker-compose.yml
        owner: ec2-user
        group: ec2-user

    - name: Copy nginx config
      ansible.builtin.copy:
        src: files/nginx.conf
        dest: /home/ec2-user/app/nginx.conf
        owner: ec2-user
        group: ec2-user

    - name: Deploy containers
      ansible.builtin.command: docker compose up -d --remove-orphans
      args:
        chdir: /home/ec2-user/app
